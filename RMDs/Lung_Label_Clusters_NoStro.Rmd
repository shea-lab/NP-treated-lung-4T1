---
title: "Label_Clusters"
output: html_document:
  fig_crop: no

date: "2024-05-01"
---
# Setup 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(Seurat)
library(dplyr)
library(readr)
library(tidyverse)

# Load libraries
library(SingleCellExperiment)
library(Matrix)
library(scales)
library(cowplot)
library(RCurl)
library(AnnotationDbi)
library(org.Mm.eg.db)
library(clusterProfiler)
```

# Load Data
```{r}
data = readRDS("~/Documents/Kate/NMMscRNAseq/Data/integrated_merged_sct_filtered_tnbc_object.rds")


# visualize to make sure it's properly loaded 
Idents(data) <- data@meta.data$SCT_snn_res.0.6
DimPlot(data)
```



# Create lung without stromal object 
```{r}
Idents(data) <- data@meta.data$shortname
data2 <- subset(data, idents = c("lung_imm", "lung_tb", "lung_np"))
data2@meta.data$shortname <- data2@active.ident

DimPlot(data2, label = T, split.by = "shortname")
```

```{r}
Idents(data2) <- "SCT_snn_res.0.6"
Idents(data) <- "SCT_snn_res.0.6"

DimPlot(data2, label = T, split.by = "shortname")
DimPlot(data, label = T, split.by = "shortname")
```


```{r}
data <- lung
rm(lung)
```


# re-run SCT and cluster ID with only lung
## SCT
```{r}
data <- SCTransform(data)
data <- RunPCA(data)
data <- FindNeighbors(data, dims = 1:30)
data <- FindClusters(data)
data <- RunUMAP(data, dims = 1:30)
DimPlot(data, reduction = "umap", group.by = c("sample", "seurat_clusters"))
```

## Integrate
```{r}
# integrate datasets
data <- IntegrateLayers(object = data, method = CCAIntegration, normalization.method = "SCT", verbose = F)
data <- FindNeighbors(data, reduction = "integrated.dr", dims = 1:30)
data <- FindClusters(data, resolution = 0.6)
```

```{r}
data <- RunUMAP(data, dims = 1:30, reduction = "integrated.dr")
DimPlot(data, reduction = "umap", group.by = c("shortname", "SCT_snn_res.0.6"))
```

```{r}
DimPlot(data, split.by = "shortname")
```

```{r}
saveRDS(data, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_integrated_merged_sct_filtered_object.rds")
```


# Visualize Immune vs Stromal Populations
```{r}
FeaturePlot(data, features = c("Ptprc", "Col1a1", "Cd44"))
```
# Optimize Resolution Parameter
```{r}
data <- FindClusters(data, res = c(0.4, 0.6, 0.8, 1.0, 1.2, 1.4))
```
Look at different resolutions 
```{r}
# explore resolutions 
Idents(data) <- "SCT_snn_res.0.8"

DimPlot(data, reduction = "umap", label = T, label.size = 6)
```
```{r}
Idents(data) <- "SCT_snn_res.0.6"

DimPlot(data, reduction = "umap", label = T, label.size = 6)
```


```{r}
Idents(data) <- "SCT_snn_res.0.4"

DimPlot(data, reduction = "umap", label = T, label.size = 6)
```

```{r}
Idents(data) <- "SCT_snn_res.1.4"

DimPlot(data, reduction = "umap", label = T, label.size = 6)
```

## Graph res selection
```{r}
DimPlot(data, reduction = "umap", group.by = c("shortname", "SCT_snn_res.0.8"))
```


# Look at Clusters
Count of cells in each cluster per condition
```{r}
Idents(data) <- "SCT_snn_res.0.6"
n_cells <- FetchData(data, vars = c("ident", "shortname")) %>% 
  dplyr::count(ident, shortname) %>% 
  tidyr::spread(ident, n)

n_cells
```

## Look through gene names
```{r}
gene_list <- Features(data)
gene_list <- str_split(gene_list, "/t")
```

## Cell cycle phase
tutorial: https://hbctraining.github.io/scRNA-seq_online/lessons/06_SC_SCT_normalization.html
** come back to this
```{r}
# DimPlot(data, label = T, split.by = "Phase")
```

# Clustering Analysis
tutorial: https://hbctraining.github.io/scRNA-seq/lessons/08_SC_clustering_quality_control.html
cell type markers: https://docs.google.com/spreadsheets/d/1WksC1b-KfHl0X1AVh4jKY-fs6LN3IR42KIqhN_kpta0/edit#gid=0

Reference paper, SCI single cell popultions: https://doi.org/10.1084/jem.20210040
  Milich et al

Cell types we expect: 
general immune cells 
specialized neural cells (microglia, astrocytes, glia, neurons)
stromal cells 

```{r}
# Select the RNA counts slot to be the default assay
DefaultAssay(data) <- "RNA"

# Normalize RNA data for visualization purposes
data <- NormalizeData(data, verbose = FALSE)
```

# Immune Cell ID

```{r}
DimPlot(data, label = T, split.by = "shortname")
```

From OneNote 'Gene Marker List' Spine: 
Cd3e, Cd4, Cd8a (T Cells)
Ncr1, Klrb1c, Klre1 (NK Cells)
Cd79a, Cd19, Ms4a1, Iglc3 (B Cells)
Ighm (Plasma) 
Itgam (Cd11b, many cells)
Cd33 (myeloid)
Ly6c2, Cd14, Ccr2 (Monocytes)
Smox, Apoe, Adgre1 (Macrophages)
Tmem119, Trem2, P2ry12 (Microglia)
Camp, Retnlg, Ly6g (Neutrophils)
Cd86, Siglech, Klk1 (DCs)
Hcrtr2, Fcer1a, Il3ra (Basophils)
Ccr3, Siglecf, Cd44 (Eosinophils) 

```{r immune_id, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Cd3e", "Cd4", "Cd8a",
                            "Ncr1", "Klrb1c", "Klre1",
                            "Cd79a", "Cd19", "Ms4a1", "Iglc3",
                            "Ighm",
                            "Itgam",
                            "Cd33",
                            "Ly6c2", "Cd14", "Ccr2",
                            "Smox", "Apoe", "Adgre1",
                            "Tmem119", "Trem2", "P2ry12",
                            "Camp", "Retnlg", "Ly6g",
                            "Cd86", "Siglech", "Klk1",
                            "Hcrtr2", "Fcer1a", "Il3ra",
                            "Ccr3", "Siglecf", "Cd44")) + RotatedAxis()
```

check feature plot, look for myeloid cluster (Cd33+), immune (Cd45+), stromal (Dcn, Serping1), 
epithelial (Qsox1, Mfge3, Epcam, Cdh1), mesenchyman (Vim), Endothelial (Cav1, Cd34, Cd93), lymphatic endothelial (Lyve1, Pdpn),
Fibroblast (Col1a1, Col3a1, Col5a1, Cald1), Eosinophil (Ccr3, Adgre1, Itgam/CD11b, Siglecf, Pgp1), Basophil (Hcrtr2, Fcer1a, Il3ra),
DC (Cd86)
```{r type_id, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c( "Cd33", "Ptprc", 
                                  "Dcn", "Serping1", 
                                  "Osox1", "Mfge3", "Krt5", "Epcam", "Cdh1", 
                                  "Vim", 
                                  "Cav1", "Cd34", "Cd93", "Pecam1", "Icam1", 
                                  "Lyve1", "Pdpn",
                                  "Col1a1", "Col3a1", "Col5a1", "Cald1", 
                                  "Ccr3", "Itgam", "Siglecf", "Pgp1", 
                                  "Hcrtr2", "Fcer1a", "Il3ra", 
                                  "Cd86")) + RotatedAxis()
```
Sophia's Markers 
paper: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9643644/
Single-cell RNA seq identifies anti-cancer immune phenotypes 
from the supplmental file 
Emr1 = Adgre1
Ly6c2 not found- monocyte marker, replaced with Cd14

Mrc1 = Cd206 ? 
Ptprc=cd45, immune; itgam = cd11b, myeloid 
Cd3e = T cells; S100a4 = stromal; Fn1 = HSCs; 
Sftpc = pneumocytes; Limch1 = pneumocytes
Klrb1c = NK; Ly6g / REtnlg = neutrophils
Ly6c2 - monocytes
Emr1 (adgre1). cd68 = macrophages 
Cd34 = HSCs (hematopoietic stem cells)
Elane = granulocytes
Pecam1 = Endothelial; Siglech = DCs
Ms4a1 = B cells 
alv mac = Mrc1, Ear2 (Nr2f6)

```{r type_id_sophia, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Ptprc", "Itgam",
                          "Cd3e", "S100a4", "Fn1", "Sftpc", 
                            "Limch1", "Klrb1c", "Ly6g",
                            "Retnlg", "Cd14", "Cd68", 
                            "Adgre1", "Cd34", "Elane", 
                           "Pecam1", "Siglech", "Ms4a1", "Mrc1", "Nr2f6"
  
)) + RotatedAxis()
```


## transcription factors 
Lineage Markers
https://doi.org/10.1186/s13059-018-1416-2
hematopoietic cells, where TFs such as Gata1, Tal1, Runx1, and Klf1 were specifically active; neuronal cells, which specifically activate TFs such as Sox2, Sox21, and Pax6; epithelial cells, exhibiting high expression of genes that are crucial for epithelial cells, such as Epcam, Cldn6, Cldn7, and Cdh1; and mesoderm-derived cells, expressing marker genes including Col3a1, Pcolce, and Cdh11. 

```{r type_id_TF, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Gata1", "Tal1", "Runx1", "Klf1", 
                            "Sox2", "Sox21", "Pax6",
                            "Epcam", "Cldn6", "Cdh1", 
                            "Col3a1", "Pcolce", "Cdh11"
  
)) + RotatedAxis()
```




# Milich 2021 / PanglaoDB
```{r set clusters}
Idents(data) <- data@meta.data$SCT_snn_res.0.6
```

***6/4 try looking at DCs in lung only samples, and in NP+ only sample. Maybe other cell types are blowing out expression
CD11c = Itgax 
```{r DCs, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Itgax", "Cd86", "Siglech", "Klk1", "Cd40", "Cd80")) + RotatedAxis()

```

```{r DCs, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Itgax", "Cd83", "Lamp3", "Cd86",  
                           "Axl", "Dab2", "Fcer1a", "Il6", 
                           "Cd80", "Batf3", "Siglecf")) + RotatedAxis()

```


```{r neutrophils, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Retnlg","Ly6g","Camp","S100a9", "Mmp9",  "Cd177", "Ltf")) + RotatedAxis()
```

monocytes PanglaoDB
Cd14, Lyz, Cfp, Ccr2, Csf3r, Cd7, Tet2, Cd40, Dysf, Cmklr1, 
```{r monocytes, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
# panglaoDB
DotPlot(data, features = c("Cd14","Lyz", "Ccr2", "F10", "Plac8", "Thbs1")) + RotatedAxis()

# Biology of macrophages in the lung
DotPlot(data, features = c("Ly6c2","C5ar1", "Ccr2", "Fn1", "Vcan", "Csf1r", "Il1b", "Mafb")) + RotatedAxis()

```

```{r macrophages, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Adgre1", "Cd68", "Itgam", "Smox", "Apoe")) + RotatedAxis()
```


```{r dividing myeloid, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Top2a", "Mki67", "Cdk1", "Ccnb2")) + RotatedAxis()
```

```{r fibroblast, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Col1a1", "Col6a1", "Dcn", "Lum", "Postn")) + RotatedAxis()
```

```{r endothelial, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Pecam1", "Kdr", "Flt1")) + RotatedAxis()
```

## Myeloid Subtypes: Biology of Lung Macrophages in Health and Disease
using Biology of Lung Macrophages in Health and Disease as a reference, check genes from scRNAseq 
alveolar macrophages (AM) - first line defenders aof alveoli and airwayss
lung interstitual macrophages (IM) - gatekeepers of vascularture and lung interstitium 
recruited macrophages (recMacs) - recruited monocytes that become part of the lung macrophage pool, unique transcriptome and function




```{r}
Idents(data) <- data@meta.data$SCT_snn_res.0.6
```

DCs: Cd26, Flt3, Zbtb46
monocytes: Ly6c2, Ccr2, C5ar1, Fn1, Vcan, Csfr1, 
IM: Pf4, C1wa, Mafb, C5ar1, Apoe 
AM: Chil3, Pparg, Fabp4, Fabp5, Ear1, Krt79, Car4
```{r comapre all }
DotPlot(data, features = c("Cd26", "Flt3", "Zbtb46", "Ly6c2","Cd14", "Ccr2", "C5ar1", "Fn1", "Vcan", "Csfr1",
                               "Chil3", "Pparg", "Fabp4", "Fabp5", "Ear1", "Krt79", "Car4")) +
  
  RotatedAxis()
```


```{r alveolar macrophages (AM)}
DotPlot(data, features = c("Chil3", "Fabp5", "Flt1", "Pparg", "Fapb4", "Siglecf", "Car4", "Ear1", "Krt79")) + RotatedAxis()
```

```{r interstitial macrophages}
DotPlot(data, features = c("C1qa", "C1qb", "C1qc", "Pf4", "C5ar1", "Apoe", "Cd14", "Csfr1", "Mafb", "Mrc1"))+ RotatedAxis()
```
recruited macrophages
```{r recMacs}
DotPlot(data, features = c("Ly6c2", "Ccr2", "Cd14", "Fn1", "Vcan", "Il1b", "S100a6", "S100a4", "Apoe", "Mafb", "C5ar1", "Ms4a4c"))+ RotatedAxis()
```

```{r cDC1}
DotPlot(data, features = c("CD24a", "Itgae", "Xcr1", "Batf3", "Cadm1", "Dpp4", "Zbtb46", "Id2", "Flt3", "Irf8", "Tlr3", "Clec9a", "Cst3", "Wdfy4", "Cxcr3", "Rnase6", "Ccr7", "Ccl5"))+ RotatedAxis()
```

```{r cDC2}
DotPlot(data, features = c("Dpp4", "Zbtb46","Clec10a", "Ccl17", "Ccl22", "Fabp5", "S100a6", "S100a4", "Flt3", "Irf4", "H2-Ab1", "Cd209a", "Ccr7", "Ccl5"))+ RotatedAxis()
```

```{r InfcDC2}
DotPlot(data, features = c("Ifit1", "Ifit1bl1", "Ifit2", "Ifit", "Ifit3b", "Ifi205", "Ifi206", "Rsad2", "Phf11d", "Mx1", "Cmpk2", "Helz2"))+ RotatedAxis()
```

```{r pDC}
DotPlot(data, features = c("Siglech", "Ly6d", "Ccr9", "Cox6a2", "Plac8", "Ly6c2", "Tcf3", "Bst2"))+ RotatedAxis()
```

### Neutrophils/MDSC
general neut
```{r}
Idents(data) <- data@meta.data$SCT_snn_res.0.6
DotPlot(data, features = c("Il1b", "Ltf", "Mmp9", "Mmp8", "Wfdc17" ,"Cxcr4", "Fcgr3", "Il17ra", "Cxcr2", "Mpo")) + RotatedAxis()

```
MDSC
```{r}
DotPlot(data, features = c("Il1b", "Ly6g", "Ltf", "Mmp9", "Mmp8", "Wfdc17" ,"Cxcr4", "Fcgr3", "Il17ra", "Cxcr2", "Mpo")) + RotatedAxis()
```

### basophils
Hcrtr2, Fcer1a, Il3ra (Basophils)
Ccr3, Siglecf, Cd44
```{r}
DotPlot(data, features = c("Itgam", "2d7", "Hepa", "Gzmb", "Ccr3", "Hcrtr2" ,"Fcer1a", "Il3ra", "Siglecf", "Cd44", "Mpo")) + RotatedAxis()
```


### cancer 
```{r 4T1, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Epcam", "Krt18", "Mki67", "Esr1"))
```

### Lung specific cells 
```{r pulmonary_alv_type1, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default' }
DotPlot(data, features = c("Col4a3", "Cldn18", "Fstl3", "Sema3b", "Vegfa" ,"Ager", "Col4a4")) + RotatedAxis()

```


```{r pulmonary_alv_type2, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default' }
DotPlot(data, features = c("Sftpc", "Slc34a2", "Sftpa1", "Nkx2-1", "Etv5" ,"Lamp5", "Muc1", "Epcam")) + RotatedAxis()

```

```{r ionocytes, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Foxi1", "Ctfr", "Ascl3", "Foxn4", "Cyp2f2" ,"Scgb1a1", "Tfcp2l1")) + RotatedAxis()
```

```{r alv_macrophages, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Marco", "Itgax", "Mrc1", "Siglecf", "Ccl3" ,"Car4", "Lyz1")) + RotatedAxis()
```

```{r airway_goblet, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Ggh", "Muc16", "Dusp4", "Muc5b", "Ltf" ,"Muc4", "Muc20")) + RotatedAxis()
```

```{r airway_epithelial, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Aqp1", "Cdh1", "Sec14l3", "Adh7")) + RotatedAxis()
```

```{r airway_epithelial, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Aqp5", "Ager", "Pdpn", "Cav1", "Hopx", 
                           "Abca3", "Slc34a2", "Gabrp", "Mpa" ,"Sp-a", 
                           "Apoa1", "Apoa2", "Fga", "Fgg", "Fgb", "Gc", "Alb")) + RotatedAxis()
DotPlot(data, features = c("Apoa1", "Apoa2", "Fga", "Fgg", "Fgb", "Gc", "Alb")) + RotatedAxis()
```

### lineage
```{r lineage, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Ptprc", "Itgam", "Cd33", "Cd34", "Pecam1" ,"Epcam", "Col1a1")) + RotatedAxis()
```



## Identifying the Unknown Clusters
```{r join layers set id }
data <- JoinLayers(data)
Idents(data) <- data@meta.data$SCT_snn_res.0.6
```


```{r cluster 0}
FindMarkers(data, ident.1 = 19, only.pos = TRUE)[1:20,]
```

```{r cluster 1}
FindMarkers(data, ident.1 = 1, only.pos = TRUE)[1:10,]
```
```{r cluser 2}
# 
FindMarkers(data, ident.1 = 2, only.pos = TRUE)[1:10,]
```

```{r cluster 3}
FindMarkers(data, ident.1 = 3, only.pos = TRUE)[1:10,]
```
```{r cluster 7}
FindMarkers(data, ident.1 = 7, only.pos = TRUE)[1:10,]
```
```{r cluster 8}
FindMarkers(data, ident.1 = 'Unknown 1', only.pos = TRUE)[1:10,]
```
```{r cluster 9}
FindMarkers(data, ident.1 = "Unknown 2", only.pos = TRUE)[1:10,]
```
```{r cluster 10}
FindMarkers(data, ident.1 = "Unknown 3", only.pos = TRUE)[1:10,]
```
```{r cluster 16}
FindMarkers(data, ident.1 = "Cdh1+", only.pos = TRUE)[1:10,]
```
```{r cluster 21}
FindMarkers(data, ident.1 = 21, only.pos = TRUE)[1:10,]
```
```{r cluster 22}
FindMarkers(data, ident.1 = 22, only.pos = TRUE)[1:10,]
```
```{r cluster 25}
FindMarkers(data, ident.1 = 25, only.pos = TRUE)[1:10,]
```
```{r cluster 27}
FindMarkers(data, ident.1 = 27, only.pos = TRUE)[1:10,]
```
```{r cluster 28}
FindMarkers(data, ident.1 = 28, only.pos = TRUE)[1:10,]
```




# Conserved Marker ID for unknown clusters
https://hbctraining.github.io/scRNA-seq/lessons/09_merged_SC_marker_identification.html

Since we have samples representing different conditions in our dataset, our best option is to find conserved markers. This function internally separates out cells by sample group/condition, and then performs differential gene expression testing for a single specified cluster against all other clusters (or a second cluster, if specified). Gene-level p-values are computed for each condition and then combined across groups using meta-analysis methods from the MetaDE R package.

```{r}
DefaultAssay(data) <- "RNA"
Idents(data) <- data@meta.data$phenotype
```

```{r}
cluster0_conserved_markers <- FindConservedMarkers(data,
                     ident.1 = 'Neutrophil',
                     grouping.var = "shortname",
                     only.pos = TRUE,
		     min.diff.pct = 0.25,
                     min.pct = 0.25,
		     logfc.threshold = 0.25)

```

```{r}
# load annotation file
annotation <- read_csv("Data/annotation.csv")
```


```{r}
# Combine markers with gene descriptions 
cluster0_ann_markers <- cluster0_conserved_markers %>% 
                rownames_to_column(var="gene") %>% 
                left_join(y = unique(annotation[, c("gene_name", "description")]),
                          by = c("gene" = "gene_name"))

View(cluster0_ann_markers)
```


## run conserved marker on unknown clusters
```{r}
# Create function to get conserved markers for any given cluster
get_conserved <- function(cluster){
  FindConservedMarkers(subgroup,
                       ident.1 = cluster,
                       grouping.var = "shortname",
                       only.pos = TRUE) %>%
    rownames_to_column(var = "gene") %>%
    left_join(y = unique(annotation[, c("gene_name", "description")]),
               by = c("gene" = "gene_name")) %>%
    cbind(cluster_id = cluster, .)
  }
```

```{r}
Idents(data) <- data@meta.data$SCT_snn_res.0.6
# Iterate function across desired clusters
unknown_conserved_markers <- map_dfr(c(4,7,16, 21, 27, 28), get_conserved)
conserved_markers <- map_dfr(c(0:28), get_conserved)

```

## Evaluate Marker Genes
```{r}
# Extract top 10 markers per cluster
top10 <- conserved_markers %>% 
  mutate(avg_fc = (lung_stro_avg_log2FC + lung_imm_avg_log2FC + lung_np_avg_log2FC + lung_tb_avg_log2FC) / 4) %>% 
  group_by(cluster_id) %>% 
  top_n(n = 10, 
        wt = avg_fc)

# Visualize top 10 markers per cluster
View(top10)
write.csv(top10, file = "Data/top10_conserved_markers.csv")
```

## View specific cluster's conserved markers
```{r}
conserved_markers %>% filter(cluster_id == 23)
```

## test non-conserved marker
```{r}
FindMarkers(data, ident.1 = "Neutrophil")
```


## Feature Plot code
```{r pDC feat plot}
FeaturePlot(data, 
            reduction = "umap", 
            features = c("Il3ra", "Gzmb", "Serpinf1", "Itm2c"), 
            min.cutoff = 'q10', 
            label = TRUE)
```

```{r pDCs dot plot, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(data, features = c("Il3ra", "Gzmb", "Serpinf1", "Itm2c")) + 
  RotatedAxis()
```


## Naming Clusters
```{r phenotype}
Idents(data)  <- data@meta.data$SCT_snn_res.0.6
data <- RenameIdents(data, '0' = 'Neutrophil', '1' = 'Neutrophil', '2' = 'Macrophage', '3' =
                        'recMac', '4' = 'Neutrophil', '5' = 'B cell',
                      '6' = 'Endothelial', '7' = 'Unknown 1', '8' = 'Macrophage', '9' = 'NK cell',
                      '10' = 'Neutrophil', '11' = 'T cell', '12' = 'Neutrophil', '13' = 'Endothelial', 
                      '14' = 'Neutrophil', '15' = 'Endothelial', '16' = 'Unknown 2', '17' = 'Neutrophil', 
                      '18' = 'T cell', '19' = 'T cell', '20' = 'Neutrophil', '21' = 'Unknown 3',
                      '22' = 'alvMac', '23' = 'Fibroblast', '24' = 'Endothelial', '25' = 'recMac',
                      '26' = 'B cell', '27' = 'Basophils', '28' = '4T1')
data@meta.data$phenotype = data@active.ident

```

```{r}
Idents(data) <- data@meta.data$phenotype
DimPlot(data, label = TRUE, split.by="shortname")
```
```{r}
Idents(data) <- data@meta.data$phenotype
DimPlot(data, label = TRUE)
```

## Name Lineage Clusters
```{r lineage}
Idents(data)  <- data@meta.data$SCT_snn_res.0.6
data <- RenameIdents(data, '0' = 'Myeloid', '1' = 'Myeloid', '2' = 'Myeloid', '3' =
                        'Resident Immune', '4' = 'Myeloid', '5' = 'Immune',
                      '6' = 'Endothelial', '7' = 'Unknown 1', '8' = 'Myeloid', '9' = 'Immune',
                      '10' = 'Myeloid', '11' = 'Immune', '12' = 'Myeloid', '13' = 'Endothelial', 
                      '14' = 'Myeloid', '15' = 'Endothelial', '16' = 'Unknown 2', '17' = 'Myeloid', 
                      '18' = 'Immune', '19' = 'Immune', '20' = 'Myeloid', '21' = 'Unknown 3',
                      '22' = 'Resident Immune', '23' = 'Stromal', '24' = 'Endothelial', '25' = 'Resident Immune',
                      '26' = 'Immune', '27' = 'Unknown 4', '28' = 'Epithelial')
data@meta.data$lineage = data@active.ident
```

```{r}
Idents(data) <- data@meta.data$lineage
DimPlot(data, label = TRUE)

```
```{r}
DimPlot(data, split.by = "shortname")
```


```{r}
DimPlot(data, reduction = "umap", label = T, group.by = c("shortname", "lineage"))
```


```{r}
Idents(data) <- data@meta.data$lineage
DimPlot(data, reduction = "umap", label = TRUE) #+ NoLegend()
```
## Add Complete Identifier
```{r}
data@meta.data$identity <- paste0(data@meta.data$shortname, "_", data@meta.data$phenotype)
```




## Save the ID'd Object
```{r}
saveRDS(data, file = "~/Documents/Kate/NMMscRNAseq/Data/labeled_lung_int_merge_sct_filt_tnbc.rds")
data <- readRDS(file = "~/Documents/Kate/NMMscRNAseq/Data/labeled_lung_int_merge_sct_filt_tnbc.rds")
```

# Create Sub-Type R Objects
For downstream analysis, want to analyze each cell by subtype. Make separate R objects/Seurat objects for each 

```{r}
Idents(data) <- data@meta.data$phenotype
```

```{r myeloid}
neut <- subset(data, idents = c("Neutrophil"))
saveRDS(neut, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_neutrophil.rds")

recMac <- subset(data, idents = c("recMac"))
saveRDS(recMac, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_recruited_macrophage.rds")

mac <- subset(data, idents = c("Macrophage"))
saveRDS(mac, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_macrophage.rds")

alvMac <- subset(data, idents = c("alvMac"))
saveRDS(alvMac, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_alveolar_macrophage.rds")

allMac <- subset(data, idents = c("Macrophage", "recMac", "alvMac"))
saveRDS(allMac, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_all_macrophage.rds")

allMyeloid <- subset(data, idents = c("Macrophage", "recMac", "alvMac", "Neutrophil", "Unknown 1", "Unknown 2"))
saveRDS(allMyeloid, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_all_myeloid.rds")

rm(neut, recMac, mac, alvMac, allMac)
```


```{r non-myeloid}
tcell <- subset(data, idents = c("T cell"))
saveRDS(tcell, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_tcell.rds")

bcell <- subset(data, idents = c("B cell"))
saveRDS(tcell, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_bcell.rds")

endo <- subset(data, idents = c("Endothelial"))
saveRDS(endo, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_endothelial.rds")

nkcell <- subset(data, idents = c("NK cell"))
saveRDS(tcell, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_nkcell.rds")

fibro <- subset(data, idents = c("Fibroblast"))
saveRDS(fibro, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_fibroblast.rds")

cancer <- subset(data, idents = c("4T1"))
saveRDS(fibro, file = "~/Documents/Kate/NMMscRNAseq/Data/lung_4T1_cancer.rds")

rm(tcell, bcell, endo, nkcell, fibro, cancer)
```



# OLD
# Myeloid Populations Subclustering
if lineage is myeloid, group together and recluster for better res 
```{r}
Idents(data) <- data@meta.data$lineage
subgroup <- subset(data, idents = c("Myeloid"))
```

## SCT Myeloid Populations
```{r}
subgroup <- SCTransform(subgroup)
subgroup <- RunPCA(subgroup)
```


```{r}
subgroup <- FindNeighbors(subgroup, dims = 1:10)
subgroup <- FindClusters(subgroup)
subgroup <- RunUMAP(subgroup, dims = 1:10)
DimPlot(subgroup, reduction = "umap", group.by = c("sample", "seurat_clusters"))
```

```{r}
DimPlot(subgroup, label =T)
```

## ID Myeloid Cell Types
```{r immune_id, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default'}
DotPlot(subgroup, features = c("Cd3e", "Cd4", "Cd8a",
                            "Ncr1", "Klrb1c", "Klre1",
                            "Cd79a", "Cd19", "Ms4a1", "Iglc3",
                            "Ighm",
                            "Itgam",
                            "Cd33",
                            "Ly6c2", "Cd14", "Ccr2",
                            "Smox", "Apoe", "Adgre1",
                            "Tmem119", "Trem2", "P2ry12",
                            "Camp", "Retnlg", "Ly6g",
                            "Cd86", "Siglech", "Klk1",
                            "Hcrtr2", "Fcer1a", "Il3ra",
                            "Ccr3", "Siglecf", "Cd44")) + RotatedAxis()
```

```{r identify myeloid subtypes}
DotPlot(subgroup, features = c("Adgre1", "Cd14", "Retnlg", "Itgax", "Siglecf", "Cd86", "Cd34"))
```
```{r}
DotPlot(subgroup, features = c("Marco", "Itgax", "Mrc1", "Siglecf", "Ccl3" ,"Car4", "Lyz1", "Siglec1")) + RotatedAxis()

```

## Myeloid Subtypes: Biology of Lung Macrophages in Health and Disease
using Biology of Lung Macrophages in Health and Disease as a reference, check genes from scRNAseq 
alveolar macrophages (AM) - first line defenders aof alveoli and airwayss
lung interstitual macrophages (IM) - gatekeepers of vascularture and lung interstitium 
recruited macrophages (recMacs) - recruited monocytes that become part of the lung macrophage pool, unique transcriptome and function




```{r}
Idents(myeloid) <- subgroup@meta.data$SCT_snn_res.0.4
```

DCs: Cd26, Flt3, Zbtb46
monocytes: Ly6c2, Ccr2, C5ar1, Fn1, Vcan, Csfr1, 
IM: Pf4, C1wa, Mafb, C5ar1, Apoe 
AM: Chil3, Pparg, Fabp4, Fabp5, Ear1, Krt79, Car4
```{r comapre all }
DotPlot(data, features = c("Cd26", "Flt3", "Zbtb46", "Ly6c2", "Ccr2", "C5ar1", "Fn1", "Vcan", "Csfr1",
                               "Chil3", "Pparg", "Fabp4", "Fabp5", "Ear1", "Krt79", "Car4")) +
  
  RotatedAxis()
```


```{r alveolar macrophages (AM)}
DotPlot(subgroup, features = c("Chil3", "Fabp5", "Flt1", "Pparg", "Fapb4", "Siglecf", "Car4", "Ear1", "Krt79")) + RotatedAxis()
```

```{r interstitial macrophages}
DotPlot(subgroup, features = c("C1qa", "C1qb", "C1qc", "Pf4", "C5ar1", "Apoe", "Cd14", "Csfr1", "Mafb", "Mrc1"))+ RotatedAxis()
```
recruited macrophages
```{r recMacs}
DotPlot(subgroup, features = c("Ly6c2", "Ccr2", "Cd14", "Fn1", "Vcan", "Il1b", "S100a6", "S100a4", "Apoe", "Mafb", "C5ar1", "Ms4a4c"))+ RotatedAxis()
```

```{r cDC1}
DotPlot(subgroup, features = c("CD24a", "Itgae", "Xcr1", "Batf3", "Cadm1", "Dpp4", "Zbtb46", "Id2", "Flt3", "Irf8", "Tlr3", "Clec9a", "Cst3", "Wdfy4", "Cxcr3", "Rnase6", "Ccr7", "Ccl5"))+ RotatedAxis()
```

```{r cDC2}
DotPlot(subgroup, features = c("Cpp4", "Zbtb46","Clec10a", "Ccl17", "Ccl22", "Fabp5", "S100a6", "S100a4", "Flt3", "Irf4", "H2-Ab1", "Cd209a", "Ccr7", "Ccl5"))+ RotatedAxis()
```

```{r InfcDC2}
DotPlot(subgroup, features = c("Ifit1", "Ifit1bl1", "Ifit2", "Ifit", "Ifit3b", "Ifi205", "Ifi206", "Rsad2", "Phf11d", "Mx1", "Cmpk2", "Helz2"))+ RotatedAxis()
```

```{r pDC}
DotPlot(subgroup, features = c("Siglech", "Ly6d", "Ccr9", "Cox6a2", "Plac8", "Ly6c2", "Tcf3", "Bst2"))+ RotatedAxis()
```

## look at unknown clusters 
```{r cluster 17 unknown}
FindMarkers(subgroup, ident.1 = 17, only.pos = TRUE)[1:10,]
```

## Name myeloid clusters 
```{r name myeloid clusters}
Idents(subgroup)  <- data@meta.data$SCT_snn_res.0.6
data <- RenameIdents(data, '0' = 'Neutrophil', '1' = 'Neutrophil', '2' = 'Macrophage', '3' =
                        'Unkown 1', '4' = 'Neutrophil', '5' = 'B cell',
                      '6' = 'Endothelial', '7' = 'Unknown 2', '8' = 'Macrophage', '9' = 'NK cell',
                      '10' = 'Neutrophil', '11' = 'T cell', '12' = 'Neutrophil', '13' = 'Endothelail', 
                      '14' = 'Neutrophil', '15' = 'Endothelial', '16' = 'Unknown 3', '17' = 'Neutrophil', 
                      '18' = 'Alveolar macrophages', '19' = 'T cell', '20' = 'Neutrophil', '21' = 'Unknown 4')
data@meta.data$phenotype = data@active.ident

```



# DCs Subpopulations
https://onlinelibrary.wiley.com/doi/pdf/10.1002/eji.202149548
all: CD11c [Itgax], MHCII [H2-Ab1]
cDCs CD26 [Dpp4], FLT3, Zbtb46
cDC1: CD8, CD24 [Cd24a], Cd36, Cd103 [Itgae], Cd205 [Ly75], Clec9a, Langerin [CD207], Necl2 [Cadm1], Xcr1
cDC2a: Itgam, Cd209a, Sirpa, Dcir2 [Clec4a4], Cd4, Cd103 [Itgae], Esam, F4/80 [Adgre1]
cDC2b: Itgam, Cd209a, Sirpa, Dcir2; Cd14, Ccr2, Cd64, Cx3cr1, Ly6c, Clec10a, Clec12a, Mgl2, F4/80
Inf-cDC2: Itgam, Sirpa, Ccr2, Cd64, DC-sign [Cd209a], Ly6C, Mar-1

MoDC: Itgam, CD209a, Sirpa, Cd14, Ccr2, Cd64 [Fcgr1], Cx3cr1, Ly6C, Cd16/32 [Fcgr3], Cd88 [C5ar1], Cd115 [Csf1r], Cd206 [Mrc1], F4/80, Ly6C, Mar-1, MerTK

```{r cDC1}
DotPlot(data, features = c("Itgax", "H2-Ab1", "Dpp4", "Flt3", "Zbtb46", "Cd8a", "Cd24a", "Cd36", "Itgae", "Ly75","Clec9a", "Cd207", "Cadm1", "Xcr1")) + RotatedAxis()
```

```{r cDC2a, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default' }
DotPlot(data, features = c("Itgax", "H2-Ab1", "Dpp4", "Flt3", "Zbtb46", "Itgam", "Cd209a", "Sirpa", "Clec4a4", "Cd4","Itgae", "Esam", "Adgre1")) + RotatedAxis()
```

```{r cDC2b}
DotPlot(data, features = c("Itgax", "H2-Ab1", "Dpp4", "Flt3", "Zbtb46", "Itgam", "Cd209a", "Sirpa", "Clec4a4", "Cd14","Fcgr1", "Cx3cr1", "Ly6c2", "Clec10a", "Clec12a", "Mgl2", "Adgre1")) + RotatedAxis()

```

```{r inf-cDC2}
DotPlot(data, features = c("Itgax", "H2-Ab1", "Dpp4", "Flt3", "Zbtb46", "Itgam", "Cd209a", "Sirpa", "Clec4a4", "Ccr2","Fcgr1",  "Ly6c2", "Mar1")) + RotatedAxis()
```

```{r moDC}
DotPlot(data, features = c("Itgax", "H2-Ab1", "Dpp4", "Flt3", "Zbtb46", "Itgam", "Cd209a", "Sirpa", "Clec4a4", "Cd14", "Ccr2","Fcgr1", "Cx3cr1","Fcgr3", "Ly6c1", "Mar1", "C5ar1", "Csf1r", "Mrc1", "Adgre1", "Mertk")) + RotatedAxis()
```


```{r pDC, fig.height=12, fig.width=15, fig.asp=0.5 , fig.align='default' }
DotPlot(data, features = c("Il3ra", "Gzmb", "Serpinf1", "Itm2c")) + RotatedAxis()
```



# SingleR
some references/tutorials: 
Bioconductor vignette: https://bioconductor.org/packages/release/bioc/vignettes/SingleR/inst/doc/SingleR.html#2_Using_built-in_references
Bioconductor SingleR book: https://bioconductor.org/books/release/SingleRBook/introduction.html#quick-start

Cell References 
celldex: pokedex for celltypes, https://bioconductor.org/packages/3.19/data/experiment/vignettes/celldex/inst/doc/userguide.html


Install packages if not already installed: 
issue with alabaster.base , try alternate install for that package? 
https://www.bioconductor.org/packages/release/bioc/html/alabaster.base.html 
* 5/7/24 KG

```{r}
# BiocManager::install("SingleR")
# BiocManager::install("scRNAseq")
# BiocManager::install("celldex") # this one failed "ERROR: dependency ‘alabaster.base’ is not available for package # ‘celldex’
```

```{r echo=FALSE, results="hide", message=FALSE}
knitr::opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
library(BiocStyle)
# library(celldex)
library(scRNAseq)
library(SingleR)

```

Search function is throwing an error- package didn't install correctly?? 5/7/24 KG
```{r load ref dataset}
# Find all mm10 datasets involving pancreas or neurons.
scRNAseq::searchDatasets(
   defineTextQuery("GRCm38", field="genome") &
   (defineTextQuery("neuro%", partial=TRUE) | 
    defineTextQuery("spin%", partial=TRUE))
)[,c("name", "title")]
```

## obtain reference dataset

Use scRNAseq package to obtain a reference dataset: 
Zeisel A et al. (2018). Molecular architecture of the mouse nervous system. Cell 174(4), 999-1014.
mouse nervous system single cell RNA-seq from Zeisel et al 2018
Row data contains the gene symbol as well as some relevant per-gene statistics, e.g., the squared coefficient of variance, mean, and whether it was selected for downstream analyses.
Column data contains a wide variety of fields including patient-level information, sample-level sequencing statistics and many flavors of cell type classification. Note that many numeric columns may have NA values if they could not be successfully parsed form the source file.
If location=TRUE, the coordinates of the Ensembl gene models are stored in the rowRanges of the output.
All data are downloaded from ExperimentHub and cached for local re-use. Specific resources can be retrieved by searching for scRNAseq/zeisel-nervous.
```{r scRNAseq ref dataset}
ref_data <- ZeiselNervousData(location = TRUE)
```

Using celldex to obtain a reference dataset: 
```{r celldex ref dataset}
# celldex::searchReferences(
#     defineTextQuery("immun%", partial=TRUE) & 
#     defineTextQuery("10090", field="taxonomy_id")
# )

ms_ref <- celldex::MouseRNAseqData(ensembl = FALSE, cell.ont = "all")

# Immunological Genome Project (ImmGen) 
# microarray of pure mouse immune cells 
immgen_ref <- celldex::ImmGenData(ensembl = FALSE, cell.ont = "all")
```


### singleR using built in reference (Bioconductor tutorial)
```{r}
hpca.se <- HumanPrimaryCellAtlasData()
hpca.se
```

```{r}
hESCs <- LaMannoBrainData('human-es')
hESCs <- hESCs[,1:100]
```

```{r}
pred.hesc <- SingleR(test = data, ref = ref_data, assay.type.test=1,
    labels = ref_data$label.main)
```


```{r}
pred.hesc
# Summarizing the distribution:
table(pred.hesc$labels)
```

### singleR using single-cell references (Bioconductor tutorial)

```{r}
library(scRNAseq)
sceM <- MuraroPancreasData()

# One should normally do cell-based quality control at this point, but for
# brevity's sake, we will just remove the unlabelled libraries here.
sceM <- sceM[,!is.na(sceM$label)]

# SingleR() expects reference datasets to be normalized and log-transformed.
library(scuttle)
sceM <- logNormCounts(sceM)
```

```{r}
sceG <- GrunPancreasData()
sceG <- sceG[,colSums(counts(sceG)) > 0] # Remove libraries with no counts.
sceG <- logNormCounts(sceG) 
```

```{r}
pred.grun <- SingleR(test=sceG, ref=sceM, labels=sceM$label, de.method="wilcox")
table(pred.grun$labels)
```

### Visualization of singleR predictions (Bioconductor tutorial)

```{r}
plotScoreHeatmap(pred.grun)
```

```{r}
plotDeltaDistribution(pred.grun, ncol = 3)

```

```{r}
summary(is.na(pred.grun$pruned.labels))

```

```{r}
all.markers <- metadata(pred.grun)$de.genes
sceG$labels <- pred.grun$labels

# Beta cell-related markers
library(scater)
plotHeatmap(sceG, order_columns_by="labels",
    features=unique(unlist(all.markers$beta))) 
```

### accessing new references
ArrayExpress and GEOquery can be used to access any bulk or single cell datasets in ArrayExpress or GEO


# SessionInfo
```{r}
sessionInfo()
```


