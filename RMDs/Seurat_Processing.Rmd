---
title: "Seurat_Processing"
output: html_document
date: "2024-04-30"
---
# Setup and Packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages}
library(Seurat)
library(dplyr)
library(patchwork)
```


# Load Merged Seurat Object
This should be the output from Flex_Data_Processing_and_Filtering.Rmd

load either 
  scTransformed then merged object: sct_combined_filtered_tnbc_object.rds
  merged, not yet scTransformed: combined_filtered_tnbc_object.rds
  merged then scTransformed: merged_sct_filtered_tnbc_object.rds
  merged, scTransformed, then integrated: integrated_merged_sct_filtered_tnbc_object.rds

```{r}
# sctransformed layered dataset
# data <- readRDS("~/Documents/Kate/NMMscRNAseq/Data/sct_combined_filtered_tnbc_object.rds")

# only merged dataset 
data <- readRDS("~/Documents/Kate/NMMscRNAseq/Data/combined_filtered_tnbc_object.rds")

# merged then sctransformed dataset 
# sct_data <- readRDS("~/Documents/Kate/NMMscRNAseq/Data/merged_sct_filtered_tnbc_object.rds")
```

# scTransform Normalization
scTransform vignette: https://satijalab.org/seurat/articles/sctransform_vignette.html
install glmGamPoi before using, significantly improves speed
BiocManager::install("glmGamPoi")


## Archived: Integrate scTransformed Merged Dataset 
scTransform > merge > integrate

** error 5/3 ** KG
layers of scTransform are staying in layers rather than merging and making integration not work?
Need to run PCA, but need to find variable features first 
Other people same issue: https://github.com/satijalab/seurat/issues/8425
No way to unify multiple sct models 
potential solution: https://github.com/satijalab/seurat/issues/7542#issuecomment-1631534467

5/29 KG 
ability to integrate a layered sctransformed object doesn't appear to exist yet, (can't play nice with assay V5) 
so we'll just merge then transform until further notice.
```{r}
# library(Seurat) # make sure you are running SeuratV5
# options(Seurat.object.assay.version = 'v5')
# library(SeuratData)
# 
# obj <- LoadData("pbmcsca")
# obj <- UpdateSeuratObject(obj)
# obj <- subset(obj, nFeature_RNA > 1000)
# obj[["RNA"]] <- split(obj[["RNA"]], f = obj$Method)
# 
# #obj <- subset(obj, Method == "Smart-seq2", invert=T)
# #obj[["RNA"]] <- split(obj[["RNA"]], f = obj$tech)
# 
# # run sctransform
# obj <- SCTransform(obj, vst.flavor = "v2")
# obj <- RunPCA(obj, npcs = 30, verbose = FALSE)
# 
# # one-liner to run Integration
# obj <- IntegrateLayers(object = obj, method = HarmonyIntegration,
#                        orig.reduction = "pca", new.reduction = 'harmony',
#                        assay = "SCT", verbose = FALSE)
# obj <- FindNeighbors(obj, reduction = "harmony", dims = 1:30)
# obj <- FindClusters(obj, resolution = 2, cluster.name = "harmony_clusters")
# 
# #
# obj <- RunUMAP(obj, reduction = "harmony", dims = 1:30, reduction.name = "umap.harmony")
# p1 <- DimPlot(
#   obj,
#   reduction = "umap.harmony",
#   group.by = c("Method", "CellType"),
#   combine = FALSE
# )
# patchwork::wrap_plots(p1)
```

5/29 KG : attempt integration and see if I can combine the layers so it works?
```{r attempt integration}
# integrate datasets
# comb <- IntegrateLayers(object = data, method = CCAIntegration, normalization.method = "SCT", verbose = F)
# ifnb <- FindNeighbors(ifnb, reduction = "integrated.dr", dims = 1:30)
# ifnb <- FindClusters(ifnb, resolution = 0.6)
```


```{r}
# split datasets and process without integration
# data[["RNA"]] <- split(data[["RNA"]], f = data$sample)
# data <- SCTransform(data)
# data <- RunPCA(data)
# data <- RunUMAP(data, dims = 1:30)
# DimPlot(data, reduction = "umap", group.by = c("sample", "seurat_annotations"))
```



# Archived 2: old integration method (not working)
```{r plot merge, transform, no integration data }
# data <- FindVariableFeatures(data)
data <- RunPCA(data, verbose=F)
data <- RunUMAP(data, dims = 1:20, verbose =F)

ElbowPlot(data)
```


## PCA and UMAP
```{r}
data <- JoinLayers(data)
data <- FindVariableFeatures(data)
data <- RunPCA(data, verbose=F)
data <- RunUMAP(data, dims = 1:20, verbose =F)
```


```{r}
ElbowPlot(data)
```

```{r}
data <- FindNeighbors(data, dims = 1:20, verbose = F)
data <- FindClusters(data, verbose =F)
DimPlot(data, group.by = c("shortname", "seurat_clusters"), label=T)
```





# Integrate and SCT from Merged Object (working!!)
## run SCT, check dimplot 
*** It's possible we'll want to regress out cell cycle, but maybe not 5/31 KG
```{r}
ifnb <- JoinLayers(data)

# split datasets and process without integration
ifnb[["RNA"]] <- split(ifnb[["RNA"]], f = ifnb$sample)
# ifnb <- SCTransform(ifnb)
ifnb <- SCTransform(data, vars.to.regress = "percent.mt")
ifnb <- RunPCA(ifnb)
ifnb <- RunUMAP(ifnb, dims = 1:30)
DimPlot(ifnb, reduction = "umap", group.by = c("sample", "seurat_clusters"))
```

## integrate 
merged, scTransformed, then integrated: integrated_merged_sct_filtered_tnbc_object.rds

Seurat integration vignette: https://satijalab.org/seurat/articles/integration_introduction.html
Use integration method for SCtransform, not the regular one 

```{r}
# integrate datasets
ifnb <- IntegrateLayers(object = ifnb, method = CCAIntegration, normalization.method = "SCT", verbose = F)
ifnb <- FindNeighbors(ifnb, reduction = "integrated.dr", dims = 1:30)
ifnb <- FindClusters(ifnb, resolution = 0.6)
```

```{r}
ifnb <- RunUMAP(ifnb, dims = 1:30, reduction = "integrated.dr")
DimPlot(ifnb, reduction = "umap", group.by = c("shortname", "SCT_snn_res.0.6"))
```
save integrated object, 
now ready for cluster ID in Label_Clusters.Rmd file!
```{r}
saveRDS(ifnb, file = "~/Documents/Kate/NMMscRNAseq/Data/integrated_merged_sct_filtered_tnbc_object.rds")

```




