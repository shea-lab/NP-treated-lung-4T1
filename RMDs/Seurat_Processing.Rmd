---
title: "Seurat_Processing"
output: html_document
date: "2024-04-30"
---
# Setup and Packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages}
library(Seurat)
library(dplyr)
library(patchwork)
```


# Load Merged Seurat Object
This should be the output from Flex_Data_Processing_and_Filtering.Rmd

load either 
  scTransformed then merged object: sct_combined_filtered_tnbc_object.rds
 ** this one ** merged, not yet scTransformed: combined_filtered_tnbc_object.rds
  merged then scTransformed: merged_sct_filtered_tnbc_object.rds
  merged, scTransformed, then integrated: integrated_merged_sct_filtered_tnbc_object.rds

```{r}
# sctransformed layered dataset
# data <- readRDS("~/Documents/Kate/NMMscRNAseq/Data/sct_combined_filtered_tnbc_object.rds")

# only merged dataset 
data <- readRDS("~/Documents/Kate/NMMscRNAseq/Data/combined_filtered_tnbc_object.rds")

# merged then sctransformed dataset 
# sct_data <- readRDS("~/Documents/Kate/NMMscRNAseq/Data/merged_sct_filtered_tnbc_object.rds")
```

# scTransform Normalization
scTransform vignette: https://satijalab.org/seurat/articles/sctransform_vignette.html
install glmGamPoi before using, significantly improves speed
BiocManager::install("glmGamPoi")


# Integrate and SCT from Merged Object
## run SCT, check dimplot 

```{r}
ifnb <- JoinLayers(data)

# split datasets and process without integration
ifnb[["RNA"]] <- split(ifnb[["RNA"]], f = ifnb$sample)
# ifnb <- SCTransform(ifnb)
ifnb <- SCTransform(data, vars.to.regress = "percent.mt")
ifnb <- RunPCA(ifnb)
ifnb <- RunUMAP(ifnb, dims = 1:30)
DimPlot(ifnb, reduction = "umap", group.by = c("sample", "seurat_clusters"))
```

## integrate 
merged, scTransformed, then integrated: integrated_merged_sct_filtered_tnbc_object.rds

Seurat integration vignette: https://satijalab.org/seurat/articles/integration_introduction.html
Use integration method for SCtransform, not the regular one 

```{r}
# integrate datasets
ifnb <- IntegrateLayers(object = ifnb, method = CCAIntegration, normalization.method = "SCT", verbose = F)
ifnb <- FindNeighbors(ifnb, reduction = "integrated.dr", dims = 1:30)
ifnb <- FindClusters(ifnb, resolution = 0.6)
```

```{r}
ifnb <- RunUMAP(ifnb, dims = 1:30, reduction = "integrated.dr")
DimPlot(ifnb, reduction = "umap", group.by = c("shortname", "SCT_snn_res.0.6"))
```
save integrated object, 
now ready for cluster ID in Label_Clusters.Rmd file!
```{r}
saveRDS(ifnb, file = "~/Documents/Kate/NMMscRNAseq/Data/integrated_merged_sct_filtered_tnbc_object.rds")

```




